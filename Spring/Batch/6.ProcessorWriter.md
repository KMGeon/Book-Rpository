# ItemProcessor + ItemWriter



## 1. ItemWriter

- ItemWriter란 Chunk 단위로 데이터를 받아 일괄 출력 작업을 처리하는 인터페이스 이다.
  - CSV, TXT
  - XML
  - DB
  - Message Queing

- 다수의 구현체들이 itemReader와 같은 맥락으로 itemWriter와 ItemStream을 동시에 구현하고 있습니다.

- 하나의 아이템이 아닌 아이템 리스트를 전달받아 수행합니다.

- ChunkOrientedTasklet 실행 시 필수적 요소로 설정해야 합니다.

- `void write() 출력 데이터를 아이템 리스트로 받아서 처리` / 출력이 완료되고 트랜잭션이 종료되면 새로운 Chunk 단위 프로세스로 이동합니다.


### 1-1. JdbcBatchItemWriter

```java
@Bean
public JdbcBatchItemWriter<Pay> jdbcBatchItemWriter() {
    return new JdbcBatchItemWriterBuilder<Pay>()
            .dataSource(dataSource)
            .sql("INSERT INTO pay (amount, tx_name, tx_date_time) VALUES (:amount, :txName, :txDateTime)")
            .assertUpdates(boolean) // 트랜잭션 이후 하나라도 변경이 없는 경우 예외 발생여부 설정 > 기본 True
            .beanMapped() // Pojo를 InsertSQL에 매핑한다.
            .columnMapped() // Key, Value기반으로 Insert SQL의 Values를 매핑
            .build();
}
```

- Mapped는 3가지 중 하나만 사용할 수 있다.
```java
// 1. BeanMapped 방식
.beanMapped()  // VO의 필드명과 SQL의 파라미터명 매핑

// 2. ColumnMapped 방식
.columnMapped()  // ResultSet의 컬럼명과 매핑

// 3. Custom 매핑
.itemPreparedStatementSetter(new CustomItemPreparedStatementSetter())
```

<br/>

### 1-2. JpaItemWriter

- JPA Entity 기반으로 데이터를 처리하며, EntityManagerFactorty를 주입받아 사용한다.
- `Entity를 하나씩 Chunk 크기 만큼 (Insert/Merge) > Flush를 처리한다.`
- ItemReader나 ItemProcessor로 부터 아이템을 전달 받을 때는 `Entity 타입으로 받아야 한다.`

```java
@Bean
public ItemWriter<Customer2> customItemWriter() {
    return new JpaItemWriterBuilder<Customer2>()
            .entityManagerFactory(entityManagerFactory)
            .build();
}
```

#### Processor에서 List 반환 시 Writer 처리 문제

- ItemProcessor가 List를 반환할 때 ItemWriter가 이를 직접 처리할 수 없습니다.
- chunk 크기가 10일 경우, Writer는 10개의 리스트를 포함한 리스트를 받게 됩니다.
```java
public class JpaItemListWriter<T> extends JpaItemWriter<List<T>> {
    private JpaItemWriter<T> jpaItemWriter;
    
    @Override
    public void write(List<? extends List<T>> items) {
        List<T> totalList = new ArrayList<>();
        for (List<T> list: items) {
            totalList.addAll(list);
        }
        jpaItemWriter.write(totalList);
    }
}
```

## 2. ItemProcessor

### 2-1. CompositeItemProcessor

### 2-2. ClassifierCompositeItemProcessor